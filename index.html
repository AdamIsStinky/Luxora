<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Scaply Stock Simulator</title>
<style>
  body { margin:0; font-family:Arial; background:#000; color:#fff; display:flex; justify-content:center; padding:20px; }
  .container { max-width:800px; width:100%; }
  header { text-align:center; margin-bottom:20px; }
  h1 { margin:0; font-size:2rem; letter-spacing:1px; }
  #nicknameDisplay { text-align:center; margin:10px 0; color:#0ff; }
  .stats { display:flex; justify-content:space-between; background:#111; padding:15px; border-radius:8px; margin-bottom:20px; }
  .stat { text-align:center; }
  .stat h2 { margin:0; font-size:1.2rem; }
  .stat p { margin:5px 0 0; color:#bbb; }
  .controls { display:flex; gap:10px; margin-bottom:20px; }
  input { flex:1; padding:10px; border:1px solid #444; border-radius:6px; background:#111; color:#fff; }
  button { padding:10px 15px; border:none; border-radius:6px; font-weight:bold; cursor:pointer; }
  .buy { background:#0f0; color:#000; }
  .sell { background:#f00; color:#fff; }
  #changeNickname { background:#00f; color:#fff; margin-bottom:10px; }
  .chart-container { background:#111; padding:15px; border-radius:8px; margin-bottom:20px; position:relative; }
  .history { background:#111; padding:15px; border-radius:8px; max-height:300px; overflow-y:auto; }
  .history h3 { margin-top:0; }
  .history ul { list-style:none; padding:0; margin:0; }
  .history li { padding:8px 0; border-bottom:1px solid #222; }
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAtbXqId49sEwkj6zIvUzQUkfWLaZUm2EE",
  authDomain: "scaply-29f62.firebaseapp.com",
  projectId: "scaply-29f62",
  storageBucket: "scaply-29f62.firebasestorage.app",
  messagingSenderId: "505427041338",
  appId: "1:505427041338:web:a6c4e439c87ece9079a903",
  measurementId: "G-6FC2E11NN4",
  databaseURL: "https://scaply-29f62-default-rtdb.firebaseio.com/"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
</script>
</head>
<body>
<div class="container">

  <header>
    <h1>Scaply Stock Simulator</h1>
    <h3 id="nicknameDisplay">Nickname: Player</h3>
  </header>

  <div class="stats">
    <div class="stat"><h2 id="cash">$100,000</h2><p>Cash</p></div>
    <div class="stat"><h2 id="shares">0</h2><p>Shares Owned</p></div>
    <div class="stat"><h2 id="price">$100</h2><p>Scaply Price</p></div>
  </div>

  <button id="changeNickname">Change Nickname</button>

  <div class="controls">
    <input type="number" id="amount" placeholder="Enter shares..." min="1">
    <button class="buy" onclick="buy()">Buy</button>
    <button class="sell" onclick="sell()">Sell</button>
  </div>

  <div class="chart-container">
    <canvas id="priceChart" height="200"></canvas>
  </div>

  <div class="history">
    <h3>Transaction History</h3>
    <ul id="history"></ul>
  </div>

</div>

<script>
window.onload = function() {
  let userId = localStorage.getItem("scaplyUserId");
  let nickname = localStorage.getItem("scaplyNickname");
  let cash = 100000;
  let shares = 0;
  let price = 100;

  const cashEl = document.getElementById("cash");
  const sharesEl = document.getElementById("shares");
  const priceEl = document.getElementById("price");
  const historyEl = document.getElementById("history");
  const nicknameEl = document.getElementById("nicknameDisplay");

  function updateNicknameDisplay() { nicknameEl.textContent = "Nickname: " + nickname; }

  if (!nickname) {
    nickname = prompt("Enter your nickname") || "Player";
    localStorage.setItem("scaplyNickname", nickname);
  }
  updateNicknameDisplay();

  if (!userId) {
    userId = db.ref('users').push().key;
    localStorage.setItem("scaplyUserId", userId);
  }

  db.ref('users/' + userId).get().then(snapshot => {
    if (snapshot.exists()) {
      const data = snapshot.val();
      cash = data.cash;
      shares = data.shares;
    } else {
      db.ref('users/' + userId).set({ cash, shares });
    }
    updateUI();
  });

  const ctx = document.getElementById('priceChart').getContext('2d');
  const priceData = [];
  const labels = [];
  const chart = new Chart(ctx, {
    type: 'line',
    data: { 
      labels: labels, 
      datasets: [{
        label:'Scaply Price', 
        data:priceData, 
        borderColor:'#0ff', 
        backgroundColor:'rgba(0,255,255,0.2)', 
        tension:0, 
        fill:true,
        pointRadius:0
      }] 
    },
    options: {
      animation:false, // disable smooth animation
      scales: { x:{ ticks:{color:'#fff'}, grid:{color:'#222'} }, y:{ ticks:{color:'#fff'}, grid:{color:'#222'} } },
      plugins: {
        legend: { display: false },
        afterDraw: chart=>{
          const ctx = chart.ctx;
          ctx.save();
          ctx.fillStyle='rgba(200,200,200,0.6)';
          ctx.font='10px Arial';
          ctx.textAlign='right';
          ctx.fillText('Graph resets every 20 minutes', chart.width-10,15);
          ctx.restore();
        }
      }
    }
  });

  const graphRef = db.ref('graph');

  // Load initial graph
  graphRef.get().then(snapshot=>{
    const data = snapshot.val();
    const now = Date.now();
    if(data && data.points && data.lastReset && (now - data.lastReset < 20*60*1000)){
      const recentPoints = data.points.slice(-8);
      recentPoints.forEach(p => { priceData.push(p.price); labels.push(p.time); });
    }
    if(priceData.length === 0){
      priceData.push(price);
      labels.push(new Date().toLocaleTimeString());
    }
    // Trim if somehow >8
    while(priceData.length > 8){ priceData.shift(); labels.shift(); }
    chart.data.datasets[0].pointRadius = Array(chart.data.labels.length-1).fill(0).concat([3]);
    chart.update();
  });

  db.ref('price').on('value', snap=>{
    const newPrice = snap.val() || 100;
    if(newPrice !== price){
      price = newPrice;
      updateUI();
      updateChart(price);
    }
  });

  function updateChart(newPrice){
    const time = new Date().toLocaleTimeString();
    priceData.push(newPrice);
    labels.push(time);

    while(priceData.length>8){ priceData.shift(); labels.shift(); }

    chart.data.labels = [...labels];
    chart.data.datasets[0].data = [...priceData];
    chart.data.datasets[0].pointRadius = Array(chart.data.labels.length-1).fill(0).concat([3]);
    chart.update('none'); // no animation
    graphRef.set({ points: labels.map((t,i)=>({time:t,price:priceData[i]})), lastReset: Date.now() });
  }

  setInterval(()=>{
    graphRef.set({ points:[], lastReset:Date.now() });
    priceData.length=0; labels.length=0; chart.data.datasets[0].data=[]; chart.data.labels=[]; chart.update('none');
  }, 20*60*1000);

  db.ref('history').on('child_added', snap=>{
    const text = snap.val();
    const li = document.createElement("li");
    li.textContent = text;
    if(text.includes("bought")) li.style.color = "#0f0";
    else if(text.includes("sold")) li.style.color = "#f00";
    else li.style.color = "#fff";
    historyEl.prepend(li);
    while(historyEl.children.length>20) historyEl.removeChild(historyEl.lastChild);
  });

  db.ref('price').transaction(cp=>cp??100);

  setInterval(()=>{
    db.ref('price').transaction(cp=>{
      if(cp===null) return 100;
      let newPrice=Math.max(1, cp+(Math.random()-0.5)*2);
      db.ref('history').push(`Price changed to $${newPrice.toFixed(2)}`);
      return newPrice;
    });
  },3000);

  document.getElementById("changeNickname").addEventListener("click", ()=>{
    const newNick = prompt("Enter your new nickname")?.trim(); if(!newNick) return;
    nickname=newNick; localStorage.setItem("scaplyNickname", nickname); updateNicknameDisplay();
    alert(`Nickname changed to ${nickname}`);
  });

  function updateUI(){ 
    cashEl.textContent="$"+cash.toLocaleString(); 
    sharesEl.textContent=shares; 
    priceEl.textContent="$"+price.toFixed(2); 
  }

  window.buy=function(){
    const amount=parseInt(document.getElementById("amount").value); if(!amount||amount<=0) return;
    const cost=amount*price; if(cost>cash){alert("Not enough cash!"); return;}
    cash-=cost; shares+=amount;
    db.ref('users/'+userId).set({ cash, shares });
    db.ref('history').push(`${nickname} bought ${amount} shares at $${price.toFixed(2)}`);
    db.ref('price').transaction(cp=>Math.max(1, cp+Math.log10(amount+1)));
    updateUI();
  }
  window.sell=function(){
    const amount=parseInt(document.getElementById("amount").value); if(!amount||amount<=0) return;
    if(amount>shares){alert("Not enough shares!"); return;}
    cash+=amount*price; shares-=amount;
    db.ref('users/'+userId).set({ cash, shares });
    db.ref('history').push(`${nickname} sold ${amount} shares at $${price.toFixed(2)}`);
    db.ref('price').transaction(cp=>Math.max(1, cp-Math.log10(amount+1)));
    updateUI();
  }
}
</script>
</body>
</html>
